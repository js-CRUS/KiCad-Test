name: KiCad CI

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.kicad_pro"
      - "**/*.kicad_sch"
      - "**/*.kicad_pcb"
      - "**/*.kicad_sym"
      - "**/*.kicad_mod"
      - "**/*.kicad_wks"
      - "**/sym-lib-table"
      - "**/fp-lib-table"
  pull_request:
    paths:
      - "**/*.kicad_pro"
      - "**/*.kicad_sch"
      - "**/*.kicad_pcb"
      - "**/*.kicad_sym"
      - "**/*.kicad_mod"
      - "**/*.kicad_wks"
      - "**/sym-lib-table"
      - "**/fp-lib-table"

env:
  # ðŸ”§ CHANGE THIS TO MATCH YOUR PROJECT:
  # (without extension)
  PROJECT_NAME: test

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      #- name: Install KiCad
      #  run: |
      #    sudo add-apt-repository --yes ppa:kicad/kicad-8.0-releases
      #    sudo apt update
      #    sudo apt install --yes kicad kicad-cli

      - name: Prepare output folder
        run: mkdir -p outputs

      # -------------------------------------------------
      # All commands use $PROJECT_NAME automatically ðŸŽ‰
      # -------------------------------------------------

      - name: Export schematic PDF
        run: |
          kicad-cli sch export pdf "$PROJECT_NAME.kicad_sch" \
            -o outputs/schematic.pdf

      - name: Export PCB PDF
        run: |
          kicad-cli pcb export pdf "$PROJECT_NAME.kicad_pcb" \
            -o outputs/pcb.pdf

      - name: Export BOM
        run: |
          kicad-cli sch export bom "$PROJECT_NAME.kicad_sch" \
            -o outputs/bom.csv

      - name: Run ERC
        run: |
          kicad-cli sch run-erc "$PROJECT_NAME.kicad_sch" \
            --output outputs/erc.txt

      - name: Run DRC
        run: |
          kicad-cli pcb run-drc "$PROJECT_NAME.kicad_pcb" \
            --output outputs/drc.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
