name: KiCad 9 CI

on:
  push:
    branches: [ "main" ]
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  pull_request:
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  workflow_dispatch:

env:
  PROJECT_NAME: test   # <-- change this to match your .kicad_sch file

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/kicad/kicad:9.0
      options: --user root

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show KiCad version
        run: kicad-cli --version

      - name: Prepare output directory
        run: mkdir -p outputs


      # -----------------------------------------------------------------
      # CHECK WHETHER THE PCB FILE EXISTS AND HAS LAYERS
      # -----------------------------------------------------------------
      - id: check_pcb
        name: Detect PCB layers
        run: |
          PCB_FILE="${PROJECT_NAME}.kicad_pcb"

          if [ ! -f "$PCB_FILE" ]; then
            echo "HAS_PCB=false" >> $GITHUB_ENV
            echo "No PCB file found. Skipping PCB tasks."
            exit 0
          fi

          if grep -q "(layer" "$PCB_FILE"; then
            echo "HAS_PCB=true" >> $GITHUB_ENV
            echo "PCB contains layers."
          else
            echo "HAS_PCB=false" >> $GITHUB_ENV
            echo "PCB contains NO layers. Skipping PCB tasks."
          fi

      # -------------------------------------------------------------
      # RUN ERC (FAILS IF ERRORS FOUND)
      # -------------------------------------------------------------
      - name: Run ERC (Fail on errors)
        run: |
          echo "Running ERC..."
          kicad-cli sch erc "${PROJECT_NAME}.kicad_sch" \
            --output outputs/schematic/erc_report.txt
        continue-on-error: false

      # -------------------------------------------------------------
      # EXPORT SCHEMATIC PDF
      # -------------------------------------------------------------
      - name: Export Schematic PDF
        run: |
          echo "Exporting schematic PDF..."
          kicad-cli sch export pdf "${PROJECT_NAME}.kicad_sch" \
            --output outputs/pdf/schematic.pdf

      # -------------------------------------------------------------
      # CHECK PCB LAYER COUNT
      # -------------------------------------------------------------
      - name: Check PCB layers
        id: check_layers
        run: |
          if [ -n "${{ steps.find_files.outputs.pcb_file }}" ]; then
            LAYERS=$(kicad-cli pcb export info "${PROJECT_NAME}.kicad_pcb" | grep "Copper Layers" | awk '{print $3}')
            echo "layers=$LAYERS" >> $GITHUB_OUTPUT
            if [ "$LAYERS" -gt 0 ]; then
              echo "has_layers=true" >> $GITHUB_OUTPUT
            else
              echo "has_layers=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_layers=false" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------------------
      # RUN DRC (FAIL IF ERRORS, ONLY IF PCB HAS LAYERS)
      # -------------------------------------------------------------
      - name: Run DRC (Fail on errors)
        if: steps.check_layers.outputs.has_layers == 'true'
        run: |
          echo "Running DRC..."
          kicad-cli pcb drc "${PROJECT_NAME}.kicad_pcb" \
            --output outputs/pcb/drc_report.txt
        continue-on-error: false

      # -------------------------------------------------------------
      # EXPORT PCB PDF (ONLY IF BOARD HAS LAYERS)
      # -------------------------------------------------------------
      - name: Export PCB PDF
        if: steps.check_layers.outputs.has_layers == 'true'
        run: |
          echo "Exporting PCB PDF..."
          kicad-cli pcb export pdf "${PROJECT_NAME}.kicad_pcb" \
            --output outputs/pdf/pcb.pdf

      # -------------------------------------------------------------
      # UPLOAD ARTIFACTS
      # -------------------------------------------------------------
      - name: Upload KiCad artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
