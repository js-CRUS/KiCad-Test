name: KiCad 9 CI

on:
  push:
    branches: [ "main" ]
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  pull_request:
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  workflow_dispatch:

env:
  PROJECT_NAME: your_project_name   # <-- change this to match your .kicad_sch file

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/kicad/kicad:9.0
      options: --user root

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show KiCad version
        run: kicad-cli --version

      - name: Prepare output directory
        run: mkdir -p outputs


      # -----------------------------------------------------------------
      # CHECK WHETHER THE PCB FILE EXISTS AND HAS LAYERS
      # -----------------------------------------------------------------
      - id: check_pcb
        name: Detect PCB layers
        run: |
          PCB_FILE="${PROJECT_NAME}.kicad_pcb"

          if [ ! -f "$PCB_FILE" ]; then
            echo "HAS_PCB=false" >> $GITHUB_ENV
            echo "No PCB file found. Skipping PCB tasks."
            exit 0
          fi

          if grep -q "(layer" "$PCB_FILE"; then
            echo "HAS_PCB=true" >> $GITHUB_ENV
            echo "PCB contains layers."
          else
            echo "HAS_PCB=false" >> $GITHUB_ENV
            echo "PCB contains NO layers. Skipping PCB tasks."
          fi


      # -----------------------------------------------------------------
      # SCHEMATIC EXPORTS (ALWAYS RUN)
      # -----------------------------------------------------------------
      - name: Export schematic PDF
        run: |
          kicad-cli sch export pdf \
            "${PROJECT_NAME}.kicad_sch" \
            -o outputs/schematic.pdf

      - name: Generate BOM
        run: |
          kicad-cli sch export bom \
            "${PROJECT_NAME}.kicad_sch" \
            -o outputs/bom.csv

      - name: Run ERC
        run: |
          kicad-cli sch erc \
            "${PROJECT_NAME}.kicad_sch" \
            --output outputs/erc.txt


      # -----------------------------------------------------------------
      # PCB EXPORTS (ONLY IF HAS_PCB = true)
      # -----------------------------------------------------------------
      - name: Export PCB PDF
        if: env.HAS_PCB == 'true'
        run: |
          kicad-cli pcb export pdf \
            "${PROJECT_NAME}.kicad_pcb" \
            -o outputs/pcb.pdf

      - name: Run DRC
        if: env.HAS_PCB == 'true'
        run: |
          kicad-cli pcb drc \
            "${PROJECT_NAME}.kicad_pcb" \
            --output outputs/drc.txt


      # -----------------------------------------------------------------
      # ARTIFACT UPLOAD
      # -----------------------------------------------------------------
      - name: Upload KiCad outputs
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
