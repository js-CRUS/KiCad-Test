name: KiCad 9 CI

on:
  push:
    branches: [ "main" ]
    paths:
      # Only run when KiCad files change in the PROJECT ROOT (same folder as .github)
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  pull_request:
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  workflow_dispatch:

env:
  PROJECT_NAME: test   # <-- change this (no extension)

jobs:
  build:
    runs-on: ubuntu-latest

    # Use KiCad 9 prebuilt container, run as root to avoid checkout permission errors
    container:
      image: ghcr.io/kicad/kicad:9.0
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify KiCad CLI
        run: kicad-cli --version

      - name: Prepare output directory
        run: mkdir -p outputs

      # -----------------------
      # KiCad CLI steps
      # -----------------------

      - name: Export schematic PDF
        run: |
          kicad-cli sch export pdf "$PROJECT_NAME.kicad_sch" \
            -o outputs/schematic.pdf

      - name: Export PCB PDF
        run: |
          kicad-cli pcb export pdf "$PROJECT_NAME.kicad_pcb" \
            -o outputs/pcb.pdf

      - name: Generate BOM
        run: |
          kicad-cli sch export bom "$PROJECT_NAME.kicad_sch" \
            -o outputs/bom.csv

      - name: Run ERC
        run: |
          kicad-cli sch run-erc "$PROJECT_NAME.kicad_sch" \
            --output outputs/erc.txt

      - name: Run DRC
        run: |
          kicad-cli pcb run-drc "$PROJECT_NAME.kicad_pcb" \
            --output outputs/drc.txt

      # -----------------------
      # Upload build artifacts
      # -----------------------

      - name: Upload KiCad outputs
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
