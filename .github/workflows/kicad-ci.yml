name: KiCad 9 CI

on:
  push:
    branches: [ "main" ]
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  pull_request:
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  workflow_dispatch:

env:
  PROJECT_NAME: test   # <-- change this to match your .kicad_sch file

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/kicad/kicad:9.0
      options: --user root

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show KiCad version
        run: kicad-cli --version

      - name: Prepare output directory
        run: mkdir -p outputs


      # -----------------------------------------------------------------
      # CHECK WHETHER THE PCB FILE EXISTS AND HAS LAYERS
      # -----------------------------------------------------------------
      - id: check_pcb
        name: Detect PCB layers
        run: |
          PCB_FILE="${PROJECT_NAME}.kicad_pcb"

          if [ ! -f "$PCB_FILE" ]; then
            echo "HAS_PCB=false" >> $GITHUB_ENV
            echo "No PCB file found. Skipping PCB tasks."
            exit 0
          fi

          if grep -q "(layer" "$PCB_FILE"; then
            echo "HAS_PCB=true" >> $GITHUB_ENV
            echo "PCB contains layers."
          else
            echo "HAS_PCB=false" >> $GITHUB_ENV
            echo "PCB contains NO layers. Skipping PCB tasks."
          fi

      # -------------------------------------------------------------
      # RUN ERC (FAILS IF ERRORS FOUND)
      # -------------------------------------------------------------
      - name: Run ERC (Fail on errors)
        run: |
          echo "Running ERC..."
          kicad-cli sch erc "${PROJECT_NAME}.kicad_sch" \
            --output outputs/schematic/erc_report.txt
        continue-on-error: false

      # -------------------------------------------------------------
      # EXPORT SCHEMATIC PDF
      # -------------------------------------------------------------
      - name: Export Schematic PDF
        run: |
          echo "Exporting schematic PDF..."
          kicad-cli sch export pdf "${PROJECT_NAME}.kicad_sch" \
            --output outputs/pdf/schematic.pdf

      # -------------------------------------------------------------
      # CHECK PCB LAYER COUNT
      # -------------------------------------------------------------
      - name: Check PCB layers
        id: check_layers
        run: |
          PCB_PATH="${{ steps.find_files.outputs.pcb_file }}"
          echo "PCB_PATH = '$PCB_PATH'"

          if [ -z "$PCB_PATH" ]; then
            echo "has_pcb=false" >> $GITHUB_OUTPUT
            echo "has_layers=false" >> $GITHUB_OUTPUT
            echo "No PCB path found" 1>&2
            exit 0
          fi

          echo "has_pcb=true" >> $GITHUB_OUTPUT

          # Export PCB info as JSON
          INFO_JSON=$(kicad-cli pcb export info --format json "$PCB_PATH")
          echo "INFO_JSON = $INFO_JSON"

          # Use jq to extract copper_layers; fallback to 0
          LAYERS=$(echo "$INFO_JSON" | jq '.copper_layers // 0')
          echo "Raw LAYERS = '$LAYERS'"

          # Trim whitespace/newlines
          LAYERS=$(echo "$LAYERS" | xargs)

          echo "Trimmed LAYERS = '$LAYERS'"

          if [ "$LAYERS" -gt 0 ] 2>/dev/null; then
            echo "has_layers=true" >> $GITHUB_OUTPUT
          else
            echo "has_layers=false" >> $GITHUB_OUTPUT
          fi

      - name: Debug PCB flags
        run: |
          echo "has_pcb = '${{ steps.check_layers.outputs.has_pcb }}'"
          echo "has_layers = '${{ steps.check_layers.outputs.has_layers }}'"
          echo "layers raw = '${{ steps.check_layers.outputs.layers }}'"

      # -------------------------------------------------------------
      # RUN DRC (FAIL IF ERRORS, ONLY IF PCB HAS LAYERS)
      # -------------------------------------------------------------
      - name: Run DRC (Fail on errors)
        if: >
          steps.check_layers.outputs.has_pcb == 'true' &&
          steps.check_layers.outputs.has_layers == 'true'
        run: |
          kicad-cli pcb drc "${PROJECT_NAME}.kicad_pcb" \
            --output outputs/pcb/drc_report.txt
        continue-on-error: false



      # -------------------------------------------------------------
      # EXPORT PCB PDF (ONLY IF BOARD HAS LAYERS)
      # -------------------------------------------------------------
      - name: Export PCB PDF
        if: >
          steps.check_layers.outputs.has_pcb == 'true' &&
          steps.check_layers.outputs.has_layers == 'true'
        run: |
          kicad-cli pcb export pdf "${PROJECT_NAME}.kicad_pcb" \
            --output outputs/pdf/pcb.pdf



      # -------------------------------------------------------------
      # UPLOAD ARTIFACTS
      # -------------------------------------------------------------
      - name: Upload KiCad artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
