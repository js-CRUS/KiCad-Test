name: KiCad 9 CI

on:
  push:
    branches: [ "main" ]
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  pull_request:
    paths:
      - "*.kicad_sch"
      - "*.kicad_pcb"
      - "*.kicad_pro"
      - "*.kicad_sym"
      - "*.kicad_mod"
      - "sym-lib-table"
      - "fp-lib-table"

  workflow_dispatch:

env:
  PROJECT_NAME: test   # <-- change this

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/kicad/kicad:9.0
      options: --user root   # required for checkout permissions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify KiCad CLI
        run: kicad-cli --version

      - name: Prepare output directory
        run: mkdir -p outputs

      # -----------------------------------------------------
      # CHECK IF PCB HAS LAYERS
      # -----------------------------------------------------
      - id: check_pcb
        name: Detect PCB layers
        run: |
          if grep -q "(layer" "$PROJECT_NAME.kicad_pcb"; then
            echo "HAS_PCB=true" >> $GITHUB_ENV
            echo "PCB has layers. Processing PCB..."
          else
            echo "HAS_PCB=false" >> $GITHUB_ENV
            echo "No PCB layers found. Skipping PCB steps."
          fi

      # -----------------------------------------------------
      # SCHEMATIC EXPORT (always runs)
      # -----------------------------------------------------
      - name: Export schematic PDF
        run: kicad-cli sch export pdf "$PROJECT_NAME.kicad_sch" -o outputs/schematic.pdf

      - name: Generate BOM
        run: kicad-cli sch export bom "$PROJECT_NAME.kicad_sch" -o outputs/bom.csv

      - name: Run ERC
        run: kicad-cli sch run-erc "$PROJECT_NAME.kicad_sch" --output outputs/erc.txt

      # -----------------------------------------------------
      # PCB EXPORT (only if HAS_PCB=true)
      # -----------------------------------------------------

      - name: Export PCB PDF
        if: env.HAS_PCB == 'true'
        run: kicad-cli pcb export pdf "$PROJECT_NAME.kicad_pcb" -o outputs/pcb.pdf

      - name: Run DRC
        if: env.HAS_PCB == 'true'
        run: kicad-cli pcb run-drc "$PROJECT_NAME.kicad_pcb" --output outputs/drc.txt

      # -----------------------------------------------------
      # OUTPUT ARTIFACTS
      # -----------------------------------------------------
      - name: Upload KiCad outputs
        uses: actions/upload-artifact@v4
        with:
          name: kicad-outputs
          path: outputs/
